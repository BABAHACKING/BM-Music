<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Heart ‚ù§Ô∏è ‚Äì Baba Music</title>
    <link rel="stylesheet" href="utility.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ===== MY HEART PAGE STYLES ===== */
        .heart-hero {
            display: flex;
            align-items: flex-end;
            gap: 32px;
            padding: 40px 32px;
            background: linear-gradient(135deg, #0d3320, #1DB954 40%, #1ed760);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            min-height: 220px;
            position: relative;
            overflow: hidden;
        }

        .heart-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.08), transparent 60%);
        }

        .heart-hero-icon {
            width: 180px;
            height: 180px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .heart-hero-info {
            position: relative;
            z-index: 1;
        }

        .heart-hero-info .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .heart-hero-info h1 {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: -1px;
            color: #fff;
            margin-bottom: 8px;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .heart-hero-info .desc {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .heart-hero-info .count {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Content Area */
        .heart-content {
            padding: 24px 32px 120px;
        }

        .heart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .heart-tab {
            padding: 8px 20px;
            border-radius: 100px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: var(--color-text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .heart-tab:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .heart-tab.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        /* Song Row */
        .heart-song-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
            cursor: pointer;
        }

        .heart-song-row:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .heart-song-row .row-num {
            width: 24px;
            text-align: center;
            color: var(--color-text-muted);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .heart-song-row .row-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, #1DB954, #1ed760);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .heart-song-row .row-info {
            flex: 1;
            min-width: 0;
        }

        .heart-song-row .row-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .heart-song-row .row-artist {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .heart-song-row .row-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            background: rgba(255, 255, 255, 0.06);
            padding: 3px 10px;
            border-radius: 100px;
            flex-shrink: 0;
        }

        .heart-song-row .row-remove {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 1rem;
            padding: 6px;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
        }

        .heart-song-row:hover .row-remove {
            opacity: 1;
        }

        .heart-song-row .row-remove:hover {
            color: #f87171;
        }

        .heart-song-row:hover .row-num {
            color: var(--color-accent);
        }

        /* Currently playing highlight */
        .heart-song-row.playing .row-title {
            color: var(--color-accent);
        }

        .heart-song-row.playing .row-num {
            color: var(--color-accent);
        }

        /* Playlist row icon */
        .row-icon.playlist-icon {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
        }

        /* Empty state */
        .heart-page-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .heart-page-empty .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            display: block;
            animation: heartPulse 2s ease-in-out infinite;
        }

        @keyframes heartPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .heart-page-empty h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .heart-page-empty p {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .heart-page-empty .browse-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 100px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, background 0.2s;
        }

        .heart-page-empty .browse-btn:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        /* Play All Button */
        .heart-play-all {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: var(--color-accent);
            color: #000;
            border: none;
            border-radius: 100px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            margin-bottom: 24px;
        }

        .heart-play-all:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .heart-hero {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 32px 20px;
                min-height: auto;
            }

            .heart-hero-icon {
                width: 140px;
                height: 140px;
                font-size: 3.5rem;
            }

            .heart-hero-info h1 {
                font-size: 2rem;
            }

            .heart-content {
                padding: 20px 16px 120px;
            }

            .heart-tabs {
                overflow-x: auto;
            }

            .heart-song-row .row-type {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <!-- Sidebar -->
        <aside class="left" id="sidebar">
            <div class="home bg-surface rounded-lg">
                <div class="logo"><img src="logo.svg" alt="Baba Music"></div>
                <ul>
                    <li><a href="index.html"
                            style="color:inherit;text-decoration:none;display:flex;gap:12px;align-items:center;"><img
                                class="invert" src="home.svg" alt="">Home</a></li>
                </ul>
            </div>

            <div class="Library bg-surface rounded-lg">
                <div class="heading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#1DB954"
                        stroke="#1DB954" stroke-width="2">
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                    </svg>
                    <h2>My Heart Songs</h2>
                </div>
                <div class="songlist">
                    <ul id="sidebarSongs"></ul>
                </div>
                <div class="footer">
                    <div><a href="https://www.spotify.com/in-en/legal/">Legal</a></div>
                    <div><a href="https://www.spotify.com/in-en/safetyandprivacy/">Safety & Privacy</a></div>
                    <div><a href="https://www.spotify.com/in-en/legal/privacy-policy/">Privacy Policy</a></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="right">
            <div class="header">
                <div class="nav">
                    <img class="hamburger" id="hamburgerBtn" src="hamburger.svg" alt="Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"
                        onclick="history.back()" style="cursor:pointer">
                        <path d="M17 4L8.66943 10.0405C6.44352 11.6545 6.44353 12.3455 8.66943 13.9595L17 20"
                            stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none"
                        onclick="history.forward()" style="cursor:pointer">
                        <path d="M7 4L15.3306 10.0405C17.5565 11.6545 17.5565 12.3455 15.3306 13.9595L7 20"
                            stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="button">
                    <button class="Signupbtn" onclick="window.location.href='loging.html#signup'">Sign up</button>
                    <button class="Logingbtn"><a href="loging.html">Log in</a></button>
                </div>
            </div>

            <div class="spotifyplaylists" style="padding:0;">
                <!-- Hero Section -->
                <div class="heart-hero">
                    <div class="heart-hero-icon">üíö</div>
                    <div class="heart-hero-info">
                        <p class="label">Collection</p>
                        <h1>My Heart</h1>
                        <p class="desc">Your favorite songs and playlists, all in one place</p>
                        <p class="count" id="heroCount">0 items saved</p>
                    </div>
                </div>

                <!-- Content -->
                <div class="heart-content">
                    <!-- Tabs -->
                    <div class="heart-tabs">
                        <button class="heart-tab active" data-filter="all">All</button>
                        <button class="heart-tab" data-filter="songs">üéµ Songs</button>
                        <button class="heart-tab" data-filter="playlists">üìÄ Playlists</button>
                    </div>

                    <!-- Play All -->
                    <button class="heart-play-all" id="playAllBtn" style="display:none;">
                        ‚ñ∂ Play All Songs
                    </button>

                    <!-- Song List -->
                    <div id="heartList"></div>

                    <!-- Empty State -->
                    <div class="heart-page-empty" id="emptyState" style="display:none;">
                        <span class="empty-icon">üíö</span>
                        <h2>Nothing here yet!</h2>
                        <p>Start hearting songs and playlists to build your collection</p>
                        <a href="index.html" class="browse-btn">üéµ Browse Music</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Play Bar -->
    <div class="playBar" id="playbar">
        <div class="abovebar">
            <div class="songsinfo"></div>
            <div class="songsbutton">
                <img id="privious" src="privious.svg" alt="Previous">
                <img id="play" src="play.svg" alt="Play">
                <img id="next" src="next.svg" alt="Next">
            </div>
            <div style="display:flex;align-items:center;gap:12px;">
                <div class="songtime"></div>
                <div class="volume">
                    <img width="20" src="volume.svg" alt="Volume" class="invert">
                    <div class="range">
                        <input type="range" name="volume" min="0" max="100" value="50">
                    </div>
                </div>
            </div>
        </div>
        <div class="seekbar">
            <div class="circle"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="frontend-auth.js?v=999"></script>
    <script src="theme.js?v=999"></script>
    <script>
        // ===== AUDIO PLAYER =====
        let currentSong = new Audio();
        let heartSongs = [];
        let songs = []; // Cloud songs cache
        let currentFilter = 'all';

        // Turbo Optimization: Cached DOM Elements
        const elements = {
            songInfo: document.querySelector(".songsinfo"),
            songTime: document.querySelector(".songtime"),
            circle: document.querySelector(".circle"),
            seekbar: document.querySelector(".seekbar"),
            playBtn: document.getElementById("play"),
            searchInput: document.querySelector(".search-input")
        };

        function secondsToMinutesSeconds(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        async function getAllSongs() {
            // 1. Check Session Storage for Instant Cache
            const cached = sessionStorage.getItem('babaSongsCache');
            if (cached) {
                console.log('Using cached song data ‚ö°');
                songs = JSON.parse(cached);
                return songs;
            }

            try {
                if (window.supabaseClient) {
                    console.log('Fetching fresh cloud metadata...');
                    const { data, error } = await window.supabaseClient.from('songs').select('*');
                    if (error) throw error;
                    if (data) sessionStorage.setItem('babaSongsCache', JSON.stringify(data));
                    return data || [];
                }
                const response = await fetch('/api/songs');
                const result = await response.json();
                const data = result.data || [];
                if (data.length > 0) sessionStorage.setItem('babaSongsCache', JSON.stringify(data));
                return data;
            } catch (err) {
                console.error('Error loading songs:', err);
                return [];
            }
        }

        // Global buffering events
        currentSong.onwaiting = () => {
            document.getElementById('playbar')?.classList.add('buffering');
            window.babaLog?.('Buffering cloud stream...');
        };
        currentSong.onplaying = () => {
            document.getElementById('playbar')?.classList.remove('buffering');
        };
        currentSong.oncanplay = () => {
            document.getElementById('playbar')?.classList.remove('buffering');
            preloadNextTrack();
        };
        currentSong.onerror = () => {
            document.getElementById('playbar')?.classList.remove('buffering');
        };

        // Next Track Buffer (Hidden)
        let nextTrackAudio = new Audio();
        nextTrackAudio.preload = "auto";

        function preloadNextTrack() {
            if (!songs || songs.length === 0) return;
            const favSongsNames = getSavedSongs();
            let currentTitle = elements.songInfo?.innerHTML || "";
            let index = favSongsNames.findIndex(s => s.replace('.mp3', '') === currentTitle || s === currentTitle);

            if (index !== -1 && index < favSongsNames.length - 1) {
                const nextSongTitle = favSongsNames[index + 1];
                const found = songs?.find(s =>
                    s.title.toLowerCase() === nextSongTitle.toLowerCase() ||
                    s.title.toLowerCase() === nextSongTitle.replace('.mp3', '').toLowerCase()
                );

                if (found && nextTrackAudio.src !== found.audio_url) {
                    console.log('Pre-fetching next favorite:', found.title);
                    nextTrackAudio.src = found.audio_url;
                    nextTrackAudio.load();
                }
            }
        }

        const playMusic = (song, pause = false) => {
            let audioUrl, title;
            if (typeof song === 'string') {
                const found = songs?.find(s =>
                    s.title.toLowerCase() === song.toLowerCase() ||
                    s.title.toLowerCase() === song.replace('.mp3', '').toLowerCase() ||
                    s.title.toLowerCase().includes(song.replace('.mp3', '').toLowerCase())
                );
                if (found) {
                    audioUrl = found.audio_url;
                    title = found.title;
                    console.log(`Cloud match found: ${title}`);
                } else {
                    console.error('Song not found in cloud database:', song);
                    if (songs) console.log('Available titles:', songs.map(s => s.title).join(', '));
                    return;
                }
            } else if (song && song.audio_url) {
                audioUrl = song.audio_url;
                title = song.title;
            } else {
                console.error('Invalid song object provided to playMusic:', song);
                return;
            }

            currentSong.src = audioUrl;
            currentSong.onerror = () => {
                console.error(`Playback failed for: ${title}. URL: ${audioUrl}`);
            };
            if (!pause) {
                currentSong.play().catch(e => {
                    console.error('Playback error:', e.message);
                });
            }
            if (elements.playBtn) elements.playBtn.src = pause ? "play.svg" : "pause.svg";
            if (elements.songInfo) elements.songInfo.innerHTML = title;
            if (elements.songTime) elements.songTime.innerHTML = "00:00 / 00:00";
            highlightPlaying(title);
        }

        function highlightPlaying(targetTitle) {
            document.querySelectorAll('.heart-song-row').forEach(row => {
                const rowTitle = row.querySelector('.row-title')?.innerText?.trim();
                row.classList.toggle('playing', rowTitle === targetTitle);
            });
        }

        // ===== DATA =====
        function getSavedSongs() {
            return JSON.parse(localStorage.getItem('babaFavorites') || '[]');
        }

        function getSavedPlaylists() {
            return JSON.parse(localStorage.getItem('babaHeartCards') || '[]');
        }

        function removeSong(songName) {
            let favs = getSavedSongs().filter(f => f !== songName);
            localStorage.setItem('babaFavorites', JSON.stringify(favs));
            renderAll();
        }

        function removePlaylist(title) {
            let saved = getSavedPlaylists().filter(s => s.title !== title);
            localStorage.setItem('babaHeartCards', JSON.stringify(saved));
            renderAll();
        }

        // ===== RENDER =====
        function renderAll() {
            const songs = getSavedSongs();
            const playlists = getSavedPlaylists();
            const total = songs.length + playlists.length;
            const list = document.getElementById('heartList');
            const empty = document.getElementById('emptyState');
            const playAllBtn = document.getElementById('playAllBtn');
            const heroCount = document.getElementById('heroCount');

            heroCount.textContent = `${total} item${total !== 1 ? 's' : ''} saved`;
            list.innerHTML = '';

            if (total === 0) {
                empty.style.display = '';
                playAllBtn.style.display = 'none';
                return;
            }
            empty.style.display = 'none';

            let num = 1;
            const showSongs = currentFilter === 'all' || currentFilter === 'songs';
            const showPlaylists = currentFilter === 'all' || currentFilter === 'playlists';

            // Show Play All only when songs are visible
            playAllBtn.style.display = (showSongs && songs.length > 0) ? '' : 'none';

            // Render songs
            if (showSongs) {
                songs.forEach(songName => {
                    const row = document.createElement('div');
                    row.className = 'heart-song-row';
                    row.dataset.song = songName;
                    row.innerHTML = `
                        <span class="row-num">${num++}</span>
                        <div class="row-icon">üéµ</div>
                        <div class="row-info">
                            <div class="row-title">${songName.replace('.mp3', '')}</div>
                            <div class="row-artist">Ravi.S</div>
                        </div>
                        <span class="row-type">Song</span>
                        <button class="row-remove" title="Remove from My Heart">‚úï</button>
                    `;
                    row.addEventListener('click', (e) => {
                        if (e.target.closest('.row-remove')) return;
                        playMusic(songName);
                    });
                    row.querySelector('.row-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeSong(songName);
                    });
                    list.appendChild(row);
                });
            }

            // Render playlists
            if (showPlaylists) {
                playlists.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'heart-song-row';
                    row.innerHTML = `
                        <span class="row-num">${num++}</span>
                        <div class="row-icon playlist-icon">üìÄ</div>
                        <div class="row-info">
                            <div class="row-title">${item.title}</div>
                            <div class="row-artist">Playlist</div>
                        </div>
                        <span class="row-type">Playlist</span>
                        <button class="row-remove" title="Remove from My Heart">‚úï</button>
                    `;
                    row.querySelector('.row-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removePlaylist(item.title);
                    });
                    list.appendChild(row);
                });
            }

            // Render sidebar songs
            renderSidebar();
        }

        function renderSidebar() {
            const songs = getSavedSongs();
            const ul = document.getElementById('sidebarSongs');
            ul.innerHTML = '';
            songs.forEach(songName => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <img class="invert" src="music.svg">
                    <div class="info">
                        <div>${songName.replace('.mp3', '')}</div>
                        <div>Ravi.S</div>
                    </div>
                    <div class="playnow">
                        <span>Play</span>
                        <img class="invert" src="play.svg" alt="">
                    </div>
                `;
                li.addEventListener('click', () => playMusic(songName));
                ul.appendChild(li);
            });
        }

        // ===== TABS =====
        document.querySelectorAll('.heart-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.heart-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderAll();
            });
        });

        // ===== PLAY ALL =====
        document.getElementById('playAllBtn').addEventListener('click', () => {
            heartSongs = getSavedSongs();
            if (heartSongs.length > 0) playMusic(heartSongs[0]);
        });

        // ===== PLAYER CONTROLS =====
        document.getElementById("play").addEventListener("click", () => {
            if (currentSong.paused) {
                currentSong.play();
                document.getElementById("play").src = "pause.svg";
            } else {
                currentSong.pause();
                document.getElementById("play").src = "play.svg";
            }
        });

        // Time update (improved with cached elements)
        currentSong.addEventListener("timeupdate", () => {
            const duration = isNaN(currentSong.duration) ? 0 : currentSong.duration;
            const currentTime = currentSong.currentTime;
            if (elements.songTime) {
                elements.songTime.innerHTML = `${secondsToMinutesSeconds(currentTime)} / ${secondsToMinutesSeconds(duration)}`;
            }
            if (duration > 0 && elements.circle) {
                elements.circle.style.left = (currentTime / duration) * 100 + "%";
            }
        });

        // Buffered Progress
        currentSong.addEventListener("progress", () => {
            if (currentSong.buffered.length > 0 && currentSong.duration > 0) {
                const bufferedEnd = currentSong.buffered.end(currentSong.buffered.length - 1);
                const duration = currentSong.duration;
                const bufferedPercent = (bufferedEnd / duration) * 100;
                if (elements.seekbar) {
                    let bufferedBar = elements.seekbar.querySelector(".buffered-bar");
                    if (!bufferedBar) {
                        bufferedBar = document.createElement("div");
                        bufferedBar.className = "buffered-bar";
                        bufferedBar.style.position = "absolute";
                        bufferedBar.style.height = "100%";
                        bufferedBar.style.background = "rgba(255, 255, 255, 0.1)";
                        bufferedBar.style.left = "0";
                        bufferedBar.style.top = "0";
                        bufferedBar.style.pointerEvents = "none";
                        bufferedBar.style.borderRadius = "100px";
                        elements.seekbar.prepend(bufferedBar);
                    }
                    bufferedBar.style.width = bufferedPercent + "%";
                }
            }
        });

        currentSong.addEventListener("loadedmetadata", () => {
            const duration = currentSong.duration;
            if (elements.songTime) {
                elements.songTime.innerHTML = `${secondsToMinutesSeconds(currentSong.currentTime)} / ${secondsToMinutesSeconds(duration)}`;
            }
        });

        // Seekbar
        if (elements.seekbar) {
            elements.seekbar.addEventListener("click", e => {
                const rect = elements.seekbar.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width * 100;
                if (percent < 0) percent = 0;
                if (percent > 100) percent = 100;
                if (elements.circle) elements.circle.style.left = percent + "%";
                if (!isNaN(currentSong.duration)) {
                    currentSong.currentTime = (currentSong.duration * percent) / 100;
                }
            });
        }

        if (document.getElementById("privious")) {
            document.getElementById("privious").addEventListener("click", () => {
                let currentTitle = elements.songInfo?.innerHTML || "";
                const favSongs = getSavedSongs();
                let index = favSongs.findIndex(s => s.replace('.mp3', '') === currentTitle || s === currentTitle);
                if (index > 0) playMusic(favSongs[index - 1]);
            });
        }

        if (document.getElementById("next")) {
            document.getElementById("next").addEventListener("click", () => {
                let currentTitle = elements.songInfo?.innerHTML || "";
                const favSongs = getSavedSongs();
                let index = favSongs.findIndex(s => s.replace('.mp3', '') === currentTitle || s === currentTitle);
                if (index < favSongs.length - 1) playMusic(favSongs[index + 1]);
            });
        }

        currentSong.addEventListener("ended", () => {
            let currentTitle = elements.songInfo?.innerHTML || "";
            const favSongs = getSavedSongs();
            let index = favSongs.findIndex(s => s.replace('.mp3', '') === currentTitle || s === currentTitle);
            if (index < favSongs.length - 1) {
                playMusic(favSongs[index + 1]);
            } else {
                if (elements.playBtn) elements.playBtn.src = "play.svg";
            }
        });

        document.querySelector(".range input").addEventListener("input", (e) => {
            currentSong.volume = parseInt(e.target.value) / 100;
        });

        // ===== SIDEBAR TOGGLE =====
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        const hamburger = document.getElementById("hamburgerBtn");

        if (hamburger) {
            hamburger.addEventListener("click", () => {
                sidebar.classList.toggle("open");
                overlay.classList.toggle("active");
            });
        }
        if (overlay) {
            overlay.addEventListener("click", () => {
                sidebar.classList.remove("open");
                overlay.classList.remove("active");
            });
        }

        // ===== INIT =====
        async function init() {
            songs = await getAllSongs();
            renderAll();
        }
        init();
    </script>
</body>

</html>